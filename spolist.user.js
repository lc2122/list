// ==UserScript==
// @name         롤캐 Spotvnow 리스트
// @namespace    http://tampermonkey.net/
// @version      0.9.3.min.fix
// @description  롤캐 방송 목록
// @author       lc2122
// @match        https://lolcast.kr/*
// @grant        GM_xmlhttpRequest
// @require      https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js
// ==/UserScript==
(function(){'use strict';let isDarkMode=localStorage.getItem('lolcastDarkMode')==='true'||(localStorage.getItem('lolcastDarkMode')===null&&window.matchMedia('(prefers-color-scheme: dark)').matches);const styles=`#lolcastPanel{position:fixed;top:55px;right:293px;background:${isDarkMode?'#2a2a2a':'#E8E7E3'};z-index:10000;font-family:Arial,sans-serif;display:flex;flex-direction:column;border-radius:3px;color:${isDarkMode?'#ffffff':'#000000'}}#buttonContainer{display:flex;align-items:center;width:fit-content;height:28px}#spotvnowButton,#refreshButton,#modeToggleButton{background:${isDarkMode?'#3a3a3a':'#E8E7E3'};border:none;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;padding:0}#spotvnowButton img,#refreshButton img,#modeToggleButton img{width:20px;height:20px}#spotvnowButton:hover,#refreshButton:hover,#modeToggleButton:hover{background:#0056b3}#refreshButton,#modeToggleButton{display:none;margin-left:5px}#closeButton{position:fixed;top:58px;right:296px;background:#ff4d4d;border:none;cursor:pointer;width:23px;height:23px;display:none;padding:0;border-radius:50%;z-index:10001}#closeButton:hover{background:#cc0000}#closeButton img{width:11px;height:11px;display:block;margin:auto}#streamList{background:${isDarkMode?'#2a2a2a':'#E8E7E3'};margin-top:0;display:none;max-height:400px;overflow-y:auto;padding:5px;width:500px;border-radius:0 0 3px 3px;color:${isDarkMode?'#ffffff':'#000000'}}.streamItem{margin:2px 0;padding:5px;background:${isDarkMode?'rgba(80,80,80,0.9)':'rgba(255,255,255,0.9)'};border-radius:3px;cursor:pointer;display:flex;align-items:center}.streamItem:hover{background:${isDarkMode?'#7a7a7a':'#e9ecef'}}.thumbnail{width:100px;height:56px;margin-right:10px;object-fit:cover;flex-shrink:0}`;const liveStatusCache=JSON.parse(localStorage.getItem('liveStatusCache')||'{}');const thumbnailCache=JSON.parse(localStorage.getItem('thumbnailCache')||'{}');const CACHE_EXPIRY=300000;const FETCH_TIMEOUT=10000;const THUMBNAIL_TIMEOUT=15000;const DEFAULT_THUMBNAIL='https://placehold.co/100x56';const panel=document.createElement('div');panel.id='lolcastPanel';document.body.appendChild(panel);const styleSheet=document.createElement('style');styleSheet.textContent=styles;document.head.appendChild(styleSheet);const buttonContainer=document.createElement('div');buttonContainer.id='buttonContainer';panel.appendChild(buttonContainer);const spotvnowButton=document.createElement('button');spotvnowButton.id='spotvnowButton';spotvnowButton.title='Spotvnow 목록 열기/닫기';const buttonImg=document.createElement('img');buttonImg.src='https://images.icon-icons.com/3478/PNG/512/checklist_list_orderlist_order_icon_219982.png';buttonImg.alt='목록';spotvnowButton.appendChild(buttonImg);buttonContainer.appendChild(spotvnowButton);const refreshButton=document.createElement('button');refreshButton.id='refreshButton';refreshButton.title='목록 새로고침';const refreshImg=document.createElement('img');refreshImg.src='https://cdn-icons-png.flaticon.com/512/118/118797.png';refreshImg.alt='새로고침';refreshButton.appendChild(refreshImg);buttonContainer.appendChild(refreshButton);const modeToggleButton=document.createElement('button');modeToggleButton.id='modeToggleButton';modeToggleButton.title='다크/라이트 모드 전환';const modeImg=document.createElement('img');modeImg.src=isDarkMode?'https://cdn-icons-png.flaticon.com/512/581/581601.png':'https://cdn-icons-png.flaticon.com/512/3073/3073665.png';modeImg.alt='모드';modeToggleButton.appendChild(modeImg);buttonContainer.appendChild(modeToggleButton);const closeButton=document.createElement('button');closeButton.id='closeButton';closeButton.title='목록 닫기';const closeImg=document.createElement('img');closeImg.src='https://cdn-icons-png.flaticon.com/512/1828/1828778.png';closeImg.alt='닫기';closeButton.appendChild(closeImg);document.body.appendChild(closeButton);const list=document.createElement('div');list.id='streamList';panel.appendChild(list);function isCacheValid(e){return e&&Date.now()-e.timestamp<CACHE_EXPIRY}function createStreamItemHTML(e){if(!e.id)return'';return`<div class="streamItem" data-platform="${e.from}" data-id="${e.id}"><img src="${e.image}" class="thumbnail" alt="Thumbnail" onerror="this.onerror=null; this.src='${DEFAULT_THUMBNAIL}';"><div>${e.streamer} (${e.from==='muzso'?'Spotvnow':e.from}): ${e.title}</div></div>`}function updateStreamListDOM(e){const t=Array.from(new Map(e.map(e=>[e.id,e])).values());t.sort((e,t)=>{const n=parseInt(e.id.replace('lcspo',''),10),o=parseInt(t.id.replace('lcspo',''),10);return n-o});const n=t.map(createStreamItemHTML).join('');list.innerHTML=n||'라이브 스트림이 없습니다.';list.querySelectorAll('.streamItem').forEach(e=>{e.addEventListener('click',()=>{const t=e.dataset.platform,n=e.dataset.id;if(t==='muzso'){const e=n.replace('lcspo','');localStorage.setItem('pendingChannelNum',e);window.location.href='https://lolcast.kr/#/player/lolcasttv';closeButton.click()}})})};function triggerSpotvButtonClick(e){const t=document.querySelector('iframe[src*="lolcast.tv/player/lolcasttv"]')||document.querySelector('iframe');if(!t||!t.contentDocument){setTimeout(()=>triggerSpotvButtonClick(e),500);return}const n=e.padStart(2,'0'),o=`.small-channel-btn[data-url*="ch${n}-nlivecdn.spotvnow.co.kr"]`,r=t.contentDocument.querySelector(o);if(r){const e=new MouseEvent('click',{view:t.contentWindow,bubbles:!0,cancelable:!0});r.dispatchEvent(e);localStorage.removeItem('pendingChannelNum')}else setTimeout(()=>triggerSpotvButtonClick(e),1e3)}function fetchWithTimeout(e,t=FETCH_TIMEOUT){return new Promise((n,o)=>{const r=new AbortController,l=r.signal,a=setTimeout(()=>{r.abort();o(new Error('Request timed out'))},t);GM_xmlhttpRequest({method:"GET",url:e,signal:l,headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'},onload:e=>{clearTimeout(a);e.status>=200&&e.status<300?n(e.responseText):o(new Error(`Request failed with status ${e.status}`))},onerror:e=>{clearTimeout(a);o(new Error('Request failed'))},onabort:()=>{clearTimeout(a)}})})}async function generateHlsThumbnail(e,t){const n=thumbnailCache[t];if(n&&isCacheValid(n))return n.data;if(!Hls.isSupported())return DEFAULT_THUMBNAIL;return new Promise(n=>{const o=document.createElement('video');o.muted=!0;o.preload='metadata';o.crossOrigin='anonymous';o.width=100;o.height=56;const r=new Hls;let l=setTimeout(()=>{a();n(DEFAULT_THUMBNAIL)},THUMBNAIL_TIMEOUT),s=!1;const a=()=>{if(s)return;s=!0;clearTimeout(l);r&&r.destroy();if(o){o.removeEventListener('loadeddata',c);o.removeEventListener('seeked',i);o.removeEventListener('error',u);o.src=""}},c=()=>{o.removeEventListener('loadeddata',c);o.seekable.length>0&&(o.currentTime=1)},i=()=>{setTimeout(()=>{if(s)return;const e=document.createElement('canvas');e.width=100;e.height=56;const t=e.getContext('2d');try{t.drawImage(o,0,0,e.width,e.height);const r=e.toDataURL('image/png');if(r.length<200){a();n(DEFAULT_THUMBNAIL)}else{thumbnailCache[t]={data:r,timestamp:Date.now()};localStorage.setItem('thumbnailCache',JSON.stringify(thumbnailCache));a();n(r)}}catch(e){a();n(DEFAULT_THUMBNAIL)}},150)},u=e=>{a();n(DEFAULT_THUMBNAIL)};o.addEventListener('loadeddata',c);o.addEventListener('seeked',i);o.addEventListener('error',u);r.on(Hls.Events.ERROR,(e,t)=>{(t.fatal||t.type===Hls.ErrorTypes.NETWORK_ERROR)&&(a(),n(DEFAULT_THUMBNAIL))});r.loadSource(e);r.attachMedia(o)})}async function fetchSpotvnowLive(e){const t=`lcspo${e.toString().padStart(2,'0')}`,n=liveStatusCache[t];if(isCacheValid(n))return n.data;const o=e.toString().padStart(2,'0'),r=`https://ch${o}-nlivecdn.spotvnow.co.kr/ch${o}/decr/medialist_14173921312004482655_hls.m3u8`;try{await fetchWithTimeout(r,FETCH_TIMEOUT);const e=await generateHlsThumbnail(r,t);if(e===DEFAULT_THUMBNAIL){liveStatusCache[t]={data:null,timestamp:Date.now()};localStorage.setItem('liveStatusCache',JSON.stringify(liveStatusCache));return null}const n={title:`Spotvnow Channel ${e}`,from:'muzso',image:e,streamer:`Spotvnow ch${o}`,viewers:'N/A',url:`/muzso/${t}`,id:t};liveStatusCache[t]={data:n,timestamp:Date.now()};localStorage.setItem('liveStatusCache',JSON.stringify(liveStatusCache));return n}catch(e){liveStatusCache[t]={data:null,timestamp:Date.now()};localStorage.setItem('liveStatusCache',JSON.stringify(liveStatusCache));return null}}function toggleDarkMode(){isDarkMode=!isDarkMode;localStorage.setItem('lolcastDarkMode',isDarkMode);modeImg.src=isDarkMode?'https://cdn-icons-png.flaticon.com/512/581/581601.png':'https://cdn-icons-png.flaticon.com/512/3073/3073665.png';updateStyles()}function updateStyles(){const e=isDarkMode?'#2a2a2a':'#E8E7E3',t=isDarkMode?'#3a3a3a':'#E8E7E3',n=isDarkMode?'#ffffff':'#000000',o=isDarkMode?'rgba(80,80,80,0.9)':'rgba(255,255,255,0.9)',r=isDarkMode?'#7a7a7a':'#e9ecef';panel.style.background=e;panel.style.color=n;spotvnowButton.style.background=t;refreshButton.style.background=t;modeToggleButton.style.background=t;list.style.background=e;list.style.color=n;document.querySelectorAll('.streamItem').forEach(e=>{e.style.background=o;e.style.color=n;e.onmouseover=()=>{e.style.background=r};e.onmouseout=()=>{e.style.background=o}})}let loadingInterval=null;async function updateSpotvnowList(){list.style.display='block';list.innerHTML='로딩 중<span id="loadingDots">.</span>';closeButton.style.display='block';refreshButton.style.display='flex';modeToggleButton.style.display='flex';loadingInterval&&clearInterval(loadingInterval);const e=list.querySelector('#loadingDots');let t=1;loadingInterval=setInterval(()=>{t=t%3+1;e&&(e.textContent='.'.repeat(t))},500);const n=new Map,o=Array.from({length:40},(_,e)=>e+1),r=o.map(e=>fetchSpotvnowLive(e).then(t=>{const o=`lcspo${e.toString().padStart(2,'0')}`;t?n.set(t.id,t):n.delete(o)}).catch(t=>{const o=`lcspo${e.toString().padStart(2,'0')}`;n.delete(o)}));Promise.allSettled(r).then(e=>{loadingInterval&&clearInterval(loadingInterval);loadingInterval=null;updateStreamListDOM([...n.values()])})}spotvnowButton.addEventListener('click',()=>{list.style.display==='block'?closeButton.click():updateSpotvnowList()});refreshButton.addEventListener('click',()=>{updateSpotvnowList()});closeButton.addEventListener('click',()=>{list.style.display='none';closeButton.style.display='none';refreshButton.style.display='none';modeToggleButton.style.display='none';loadingInterval&&clearInterval(loadingInterval);loadingInterval=null});modeToggleButton.addEventListener('click',()=>{toggleDarkMode()});window.addEventListener('hashchange',()=>{const e=window.location.hash;if(e==='#/player/lolcasttv'){const e=localStorage.getItem('pendingChannelNum');e&&setTimeout(()=>triggerSpotvButtonClick(e),1e3)}});if(window.location.hash==='#/player/lolcasttv'){const e=localStorage.getItem('pendingChannelNum');e&&setTimeout(()=>triggerSpotvButtonClick(e),1500)}updateStyles()})();
